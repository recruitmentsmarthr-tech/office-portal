# Gemini Code Assistant Context

This document provides a comprehensive overview of the "Office Portal" project, its architecture, and operational guidelines.

## Phase 1: Development

The project is currently in the development stage.

## Project Overview

The Office Portal is a full-stack web application designed for internal office use. It features a modern web interface for user authentication, data management (specifically vector embeddings), and interaction with an AI chat service.

- **Frontend:** A responsive Single-Page Application (SPA) built with React.
- **Backend:** A RESTful API service built with Python and FastAPI.
- **Database:** A PostgreSQL database enhanced with the `pgvector` extension for efficient similarity searches on vector data.

## Technologies

| Category      | Technology / Library                                                                                               |
| :------------ | :----------------------------------------------------------------------------------------------------------------- |
| **Backend**   | [FastAPI](https://fastapi.tiangolo.com/), [SQLAlchemy](https://www.sqlalchemy.org/), [pgvector](https://github.com/pgvector/pgvector), [Alembic](https://alembic.sqlalchemy.org/), [pytest](https://docs.pytest.org/) |
| **Frontend**  | [React](https://reactjs.org/), [React Router](https://reactrouter.com/), [Axios](https://axios-http.com/), [Tailwind CSS](https://tailwindcss.com/), [Lucide React](https://lucide.dev/) |
| **Database**  | [PostgreSQL](https://www.postgresql.org/)                                                                          |
| **DevOps**    | [Docker](https://www.docker.com/), [Docker Compose](https://docs.docker.com/compose/), [Nginx](https://www.nginx.com/) |

## Architecture & Services

The application is fully containerized using Docker and managed with Docker Compose.

### Service Diagram (Production)

```
+----------------+       +-------------------+       +-----------------+
|   User/Browser |------>|      Nginx        |------>|  Frontend       |
|                |       |  (Reverse Proxy)  |       |  (React App)    |
+----------------+       |   - Port 80/443   |       +-----------------+
                         +--------+----------+
                                  |
                                  | /api
                                  v
                         +--------+----------+       +-----------------+
                         |      Backend      |<----->|   PostgreSQL    |
                         |   (FastAPI App)   |       | (with pgvector) |
                         +-------------------+       +-----------------+
```

### Services

1.  **`frontend`**:
    -   **Description**: The React-based user interface.
    -   **Build**: Uses the `frontend/Dockerfile`.
    -   **Development**: Runs on `http://localhost:3000` with live-reloading.
2.  **`backend`**:
    -   **Description**: The FastAPI application providing the API.
    -   **Build**: Uses the `backend/Dockerfile`.
    -   **Development**: Runs on `http://localhost:8000` with live-reloading.
3.  **`db`**:
    -   **Description**: The PostgreSQL database service.
    -   **Image**: `pgvector/pgvector:pg15`.
    -   **Data**: Persisted in a Docker volume named `db_data`.
    -   **Initialization**: A custom `init.sql` script is run on first startup to prepare the database.
4.  **`nginx`** (Production only):
    -   **Description**: A reverse proxy that routes incoming traffic to the appropriate service.
    -   **Configuration**: `nginx.conf`.
    -   **Routing**:
        -   `/*` -> `frontend:3000`
        -   `/api/*` -> `backend:8000`
5.  **`test`** (Development only):
    -   **Description**: A non-daemon service to run backend unit tests using `pytest`.

## How to Run

### Prerequisites

-   Docker and Docker Compose installed.
-   A `.env` file created from the `.env.example` template.

### 1. Create `.env` file

Copy `.env.example` to `.env` and fill in the required values.

```sh
cp .env.example .env
```

### 2. Development Mode

This mode uses live-reloading for both frontend and backend code.

```sh
docker-compose up --build
```

-   **Frontend**: `http://localhost:3000`
-   **Backend**: `http://localhost:8000`

### 3. Production Mode

This mode builds optimized containers and runs them behind an Nginx reverse proxy.

```sh
docker-compose -f docker-compose.prod.yml up --build
```

-   **Application**: `http://localhost` (Nginx listens on port 80)

### 4. Running Tests

To run the backend tests, use the `test` profile in the development compose file.

```sh
docker-compose --profile test up --build
```
## Gemini Added Memories
- **Current Session (January 20, 2026):**
  - **Implemented RAG System and UI Overhaul:**
    - Integrated core RAG components: document ingestion, text chunking, multilingual embedding, vector search.
    - Developed backend API endpoints for chat sessions and message history.
    - Revamped frontend with a "Clean SaaS" theme across Login, Dashboard, and Chat interfaces, including responsive design, modern styling, and interactive elements like suggestion chips.
    - Redesigned chat interface to a Gemini-like aesthetic with Markdown support.
    - Optimized Docker and performance: addressed memory issues with explicit limits, configured Webpack polling, implemented persistent model caching, and created robust model downloading scripts (`repair_model.py`, `force_fix.py`).
    - Added new API endpoints for document ingestion, chat session management, and history retrieval.
    - Switched backend chat to asynchronous processing and utilized raw Gemini REST API calls.
    - Configured "Vectors" navigation link to be visible only to Admin users.
- The project is currently in Phase 1, the development stage.
- Today, we implemented a complete UI refactor of the Admin panel, adding CRUD for users and roles with modals and confirmation dialogs, and search functionality. We improved the overall theme and fixed multiple UI bugs, including an "unclickable UI" and a squashed sidebar icon. The chat interface was also completely redesigned to a Gemini-like aesthetic with Markdown support. On the backend, we added new user/role management API endpoints and resolved a critical dependency issue by guiding you through a Docker volume clear and rebuild. We also addressed your login issue by identifying a database wipe and provided instructions to re-seed, and made the backend chat endpoint asynchronous to address a reported delay.
- During this session, we transformed the "Office Portal" application into a RAG system with long-term memory, addressing numerous frontend, backend, and Docker-related issues.

**Key Achievements:**
- **RAG System Foundation:** Implemented core RAG components including document ingestion, text chunking, multilingual embedding, and vector search.
- **Persistent Chat History:** Developed backend API endpoints for saving and loading chat sessions and messages, and wired the frontend to utilize this memory, allowing users to start new chats and resume old ones from the sidebar.
- **Frontend UI/UX Overhaul:** Applied a "Clean SaaS" design theme across the Login, Dashboard, and Chat interfaces, including responsive layouts, modern styling, and interactive elements like suggestion chips.
- **Docker & Performance Optimization:**
    - Addressed severe memory issues in both frontend and backend containers (e.g., `ENOMEM`, `Cannot allocate memory`) by:
        - Implementing explicit memory limits (`mem_limit`, `shm_size`).
        - Configuring Webpack polling (`WATCHPACK_POLLING`, `WDS_SOCKET_PORT`) for frontend stability on Windows.
        - Using stricter `.dockerignore` files to reduce build context.
    - Resolved AI model download and corruption issues by:
        - Implementing persistent model caching (`HF_HOME` volume).
        - Creating `repair_model.py` and `force_fix.py` scripts for robust model downloading with retries and cache cleaning.
    - Ensured correct Docker Compose setup for environment variables and service dependencies.
- **API Integration:** Switched the LLM generation from `google-generativeai` SDK to raw Gemini REST API calls using `requests`, configured for `gemini-2.5-flash`, and ensured proper API key handling.
- **Bug Fixes:** Resolved numerous Python `NameError`s (`unicodedata`, `asyncio`), `TypeError`s (`pgvector`), and other configuration errors that emerged during development.
- **Feature Management:** Restored the "Vectors" navigation link, making it visible only to Admin users.

The application is now fully functional, visually appealing, and robust.
- During our last session, we resolved several critical issues. We fixed Docker container memory errors (ENOMEM, 'Cannot allocate memory') by setting explicit memory limits (`mem_limit`, `shm_size`) and configuring Webpack polling for the frontend container on Windows. We addressed AI model download and corruption issues by creating a persistent Hugging Face cache volume (`HF_HOME`) and implementing robust download scripts (`repair_model.py`, `force_fix.py`) with retries and cache cleaning. We also fixed various Python errors and ensured the correct Docker Compose setup for service dependencies and environment variables.